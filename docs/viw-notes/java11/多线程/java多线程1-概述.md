[TOC]

# 线程和进程概念



## 进程和线程

> 说多线程之前先说一下进程和线程的历史和概念，

**其实简单一句话就是：**

- 1.进程：你打开一个应用程序，你在windows操作系统打开QQ，这就是一个进程，操作系统可操作管理的基本单元
- 2.线程：你打开这个QQ.exe后，你发信息给你的好友，然后又发文件给你的好友，这就是这个QQ.exe运行的两个子任务，就是线程

**比较书面的就是：**

- 1.是否单独占有内存地址空间及其它系统资源
- 2.**进程是操作系统进行资源分配的基本单位，而线程是操作系统进行调度的基本单位**



## 并发和多线程的关系

> 在多线程来解决高并发之前，还提出过多进程

进程是这个应用程序在内存中分配的内存。

以前大多数都是单核，通过这个来实现并没有实质性的提高

因为操作系统任务调度 在这里通过 ==CPU采用时间片轮转==的方式运行进程CPU为每个进程分配一个时间段，称作它的时间片。如果在时间片结束时进程还在运行，则暂停这个进程的运行，并且CPU分配给另一个进程（这个过程叫做==上下文切换==）。如果进程在时间片结束前阻塞或结束，则CPU立即进行切换，不用等待时间片用完。

而当进程暂停时 ，则会保存当前进程的状态，下一次切换回来时根据之前保存的状态进行恢复，接着继续执行。

**需要注意的是 多进程下：**

使用进程+CPU时间片轮转方式的操作系统，在宏观上看起来同一时间段执行多个任务，换句话说，**进程让操作体统的并发成为了可能**。虽然并发从宏观上看有多个任务在执行，但在事实上，对于**单核CPU**来说，任意具体时刻都只有一个任务在占用CPU资源。

> 说一下两种线程任务调度策略（比较多的是下面这两种）
>
> - 1.**抢占式调度**：系统来控制每一条线程 的时间片 切换等，有些多 有些少，这样不会因为某一条线程的阻塞而导致所有受影响
> - 2.**协同式调度**：某一条线程执行完以后 释放资源 系统通知 切换线程 执行，如果这一条线程阻塞，那么剩下的都会受影响，可能导致更大的问题。这种情况没有线程同步的问题，
>
> 在jvm 规范中，线程是有优先级的，java世界中线程任务调度是**抢占式调度**。涉及到jvm的实现，按照优先级分配cpu时间片，要么线程方法执行完成，要么阻塞，要么主动放弃

==总结：多进程也可以实现并发，但是1：进程间的通信比较复杂，而线程间的通信比较简单，通常情况下，我们需要使用共享资源，这些资源在线程间的通信比较容易。2.进程是重量级的，而线程是轻量级的，多线程方式的系统开销更小==



> 并发和多线程的问题

- 1.高并发和多线程。多线程是实现高并发的其中一环
- 2.多线程对于高并发的作用是不浪费计算机资源，提高利用率。
- 3.加机器可以解决高并发，但是如果遇到并发就加机器，那就毫无意义了。



# 多线程



## 什么是多线程

> java天生就适应多线程
>
> 通过编写多线程的编码程序来通过充分利用cpu

多线程就好比一个应用程式中有多个执行线程，简单一句话 多线程应用程序就像具有多个CPU同时执行代码的不同部分的应用程序。

![image-20201115235336651](https://xiaoboblog-bucket.oss-cn-hangzhou.aliyuncs.com/blog/image-20201115235336651.png)



## 多线程的上下文切换

> 上下文切换：指 CPU 从一个进程（或线程）切换到另一个进程（或线程）。

CPU通过为每个线程分配CPU时间片(涉及到线程调度)来实现多线程机制。CPU通过时间片分配算法来循环执行任务，当前任务执行一个时间片后会切换到下一个任务。





## 多线程的优点

> 常见优点

- 更好地利用单个CPU;
- 更好地利用多个CPU或CPU内核;
- 更好的用户体验和响应能力;
- 更好的用户体验和公平性



## 多线程的代价

> 在多线程访问共享数据的时候，这部分代码需要特别的注意。线程之间的交互往往非常复杂。
>
> 上下文切换的开销
>
> 增加资源的消耗：线程在运行的时候需要从计算机里面得到一些资源。除了CPU，线程还需要一些内存来维持它本地的堆栈。它也需要占用操作系统中一些资源来管理线程。

## 对线程的分析

> 查看线程的状态，可以使用下面三种命令

- 1.jps+jstack.exe

  - ```shell
    # 进入 jdk  bin 目录
    C:\jdk1.8\bin> jps
    ...
    C:\jdk1.8\bin> jstack -l  pid
    ```

    

- 2.jmc.exe

  - 双击 jmc.exe 命令   双击 对应进程， 双击 MBen服务器，  单击 线程 选项卡

- 3.jvisualvm.exe

  - 双击 jvisualvm.exe 命令



参考 `https://www.zhihu.com/column/jdk-source`

参考 `并发编程的艺术`

参考 `多线程核心编程技术`

参考 `https://github.com/CL0610/Java-concurrency`

参考 `github多个并发知识分享`

